// SPDX-License-Identifier: MIT
//
// Copyright 2025 Michael Rodriguez
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the “Software”), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

#pragma once

#include "common/types.h"
#include "util.h"

#define SYSCTL_CCLK_HZ (mhz_to_hz(96))
#define SYSCTL_XTAL_HZ (mhz_to_hz(12))
#define SYSCTL_IRC_HZ (mhz_to_hz(4))
#define SYSCTL_RTC_HZ (khz_to_hz(32))

enum sysctl_reg {
	SYSCTL_REG_FLASHCFG = 0x400FC000,
	SYSCTL_REG_PLL0CON = 0x400FC080,
	SYSCTL_REG_PLL0CFG = 0x400FC084,
	SYSCTL_REG_PLL0STAT = 0x400FC088,
	SYSCTL_REG_PLL0FEED = 0x400FC08C,
	SYSCTL_REG_PCONP = 0x400FC0C4,
	SYSCTL_REG_CCLKCFG = 0x400FC104,
	SYSCTL_REG_USBCLKCFG = 0x400FC108,
	SYSCTL_REG_CLKSRCSEL = 0x400FC10C,
	SYSCTL_REG_SCS = 0x400FC1A0,
	SYSCTL_REG_PCLKSEL0 = 0x400FC1A8,
	SYSCTL_REG_PCLKSEL1 = 0x400FC1AC,
	SYSCTL_REG_CLKOUTCFG = 0x400FC1C8
};

enum sysctl_pconp_bit {
	SYSCTL_PCONP_BIT_PCTIM0 = BIT_1,
	SYSCTL_PCONP_BIT_PCTIM1 = BIT_2,
	SYSCTL_PCONP_BIT_PCUART0 = BIT_3,
	SYSCTL_PCONP_BIT_PCUART1 = BIT_4,
	SYSCTL_PCONP_BIT_PCPWM1 = BIT_6,
	SYSCTL_PCONP_BIT_PCI2C0 = BIT_7,
	SYSCTL_PCONP_BIT_PCSPI = BIT_8,
	SYSCTL_PCONP_BIT_PCRTC = BIT_9,
	SYSCTL_PCONP_BIT_PCSSP1 = BIT_10,
	SYSCTL_PCONP_BIT_PCADC = BIT_12,
	SYSCTL_PCONP_BIT_PCCAN1 = BIT_13,
	SYSCTL_PCONP_BIT_PCCAN2 = BIT_14,
	SYSCTL_PCONP_BIT_PCGPIO = BIT_15,
	SYSCTL_PCONP_BIT_PCRIT = BIT_16,
	SYSCTL_PCONP_BIT_PCMCPWM = BIT_17,
	SYSCTL_PCONP_BIT_PCQEI = BIT_18,
	SYSCTL_PCONP_BIT_PCI2C1 = BIT_19,
	SYSCTL_PCONP_BIT_PCSSP0 = BIT_21,
	SYSCTL_PCONP_BIT_PCTIM2 = BIT_22,
	SYSCTL_PCONP_BIT_PCTIM3 = BIT_23,
	SYSCTL_PCONP_BIT_PCUART2 = BIT_24,
	SYSCTL_PCONP_BIT_PCUART3 = BIT_25,
	SYSCTL_PCONP_BIT_PCI2C2 = BIT_26,
	SYSCTL_PCONP_BIT_PCI2S = BIT_27,
	SYSCTL_PCONP_BIT_PCGPDMA = BIT_29,
	SYSCTL_PCONP_BIT_PCENET = BIT_30,
	SYSCTL_PCONP_BIT_PCUSB = BIT_31,
	SYSCTL_PCONP_BIT_ALL_MASK =
		SYSCTL_PCONP_BIT_PCTIM0 | SYSCTL_PCONP_BIT_PCTIM1 |
		SYSCTL_PCONP_BIT_PCUART0 | SYSCTL_PCONP_BIT_PCUART1 |
		SYSCTL_PCONP_BIT_PCPWM1 | SYSCTL_PCONP_BIT_PCI2C0 |
		SYSCTL_PCONP_BIT_PCSPI | SYSCTL_PCONP_BIT_PCRTC |
		SYSCTL_PCONP_BIT_PCSSP1 | SYSCTL_PCONP_BIT_PCADC |
		SYSCTL_PCONP_BIT_PCCAN1 | SYSCTL_PCONP_BIT_PCCAN2 |
		SYSCTL_PCONP_BIT_PCGPIO | SYSCTL_PCONP_BIT_PCRIT |
		SYSCTL_PCONP_BIT_PCMCPWM | SYSCTL_PCONP_BIT_PCQEI |
		SYSCTL_PCONP_BIT_PCI2C1 | SYSCTL_PCONP_BIT_PCSSP0 |
		SYSCTL_PCONP_BIT_PCTIM2 | SYSCTL_PCONP_BIT_PCTIM3 |
		SYSCTL_PCONP_BIT_PCUART2 | SYSCTL_PCONP_BIT_PCUART3 |
		SYSCTL_PCONP_BIT_PCI2C2 | SYSCTL_PCONP_BIT_PCI2S |
		SYSCTL_PCONP_BIT_PCGPDMA | SYSCTL_PCONP_BIT_PCENET |
		SYSCTL_PCONP_BIT_PCUSB
};

enum sysctl_pclksel_clk {
	SYSCTL_PCLKSEL_CCLK_DIV_4,
	SYSCTL_PCLKSEL_CCLK_DIV_1,
	SYSCTL_PCLKSEL_CCLK_DIV_2,
	SYSCTL_PCLKSEL_CCLK_DIV_3
};

enum sysctl_pclksel_mask {
	SYSCTL_PCLKSEL0_MASK_PCLK_WDT = BIT_0 | BIT_1,
	SYSCTL_PCLKSEL0_MASK_PCLK_TIMER0 = BIT_2 | BIT_3,
	SYSCTL_PCLKSEL0_MASK_PCLK_TIMER1 = BIT_4 | BIT_5,
	SYSCTL_PCLKSEL0_MASK_PCLK_UART0 = BIT_6 | BIT_7,
	SYSCTL_PCLKSEL0_MASK_PCLK_UART1 = BIT_8 | BIT_9,
	SYSCTL_PCLKSEL0_MASK_PCLK_PWM1 = BIT_12 | BIT_13,
	SYSCTL_PCLKSEL0_MASK_PCLK_I2C0 = BIT_14 | BIT_15,
	SYSCTL_PCLKSEL0_MASK_PCLK_SPI = BIT_16 | BIT_17,
	SYSCTL_PCLKSEL0_MASK_PCLK_SSP1 = BIT_20 | BIT_21,
	SYSCTL_PCLKSEL0_MASK_PCLK_DAC = BIT_22 | BIT_23,
	SYSCTL_PCLKSEL0_MASK_PCLK_ADC = BIT_24 | BIT_25,
	SYSCTL_PCLKSEL0_MASK_PCLK_CAN1 = BIT_26 | BIT_27,
	SYSCTL_PCLKSEL0_MASK_PCLK_CAN2 = BIT_28 | BIT_29,
	SYSCTL_PCLKSEL0_MASK_PCLK_ACF = BIT_30 | BIT_31,

	SYSCTL_PCLKSEL1_MASK_PCLK_QEI = BIT_0 | BIT_1,
	SYSCTL_PCLKSEL1_MASK_PCLK_GPIOINT = BIT_2 | BIT_3,
	SYSCTL_PCLKSEL1_MASK_PCLK_PCB = BIT_4 | BIT_5,
	SYSCTL_PCLKSEL1_MASK_PCLK_I2C1 = BIT_6 | BIT_7,
	SYSCTL_PCLKSEL1_MASK_PCLK_SSP0 = BIT_10 | BIT_11,
	SYSCTL_PCLKSEL1_MASK_PCLK_TIMER2 = BIT_12 | BIT_13,
	SYSCTL_PCLKSEL1_MASK_PCLK_TIMER3 = BIT_14 | BIT_15,
	SYSCTL_PCLKSEL1_MASK_PCLK_UART2 = BIT_16 | BIT_17,
	SYSCTL_PCLKSEL1_MASK_PCLK_UART3 = BIT_18 | BIT_19,
	SYSCTL_PCLKSEL1_MASK_PCLK_I2C2 = BIT_20 | BIT_21,
	SYSCTL_PCLKSEL1_MASK_PCLK_I2S = BIT_22 | BIT_23,
	SYSCTL_PCLKSEL1_MASK_PCLK_RIT = BIT_26 | BIT_27,
	SYSCTL_PCLKSEL1_MASK_PCLK_SYSCON = BIT_28 | BIT_29,
	SYSCTL_PCLKSEL1_MASK_PCLK_MC = BIT_30 | BIT_31
};

enum sysctl_flash_access_time {
	SYSCTL_FLASH_ACCESS_TIME_CLK_1,
	SYSCTL_FLASH_ACCESS_TIME_CLK_2,
	SYSCTL_FLASH_ACCESS_TIME_CLK_3,
	SYSCTL_FLASH_ACCESS_TIME_CLK_4,
	SYSCTL_FLASH_ACCESS_TIME_CLK_5,
	SYSCTL_FLASH_ACCESS_TIME_CLK_6
};

enum sysctl_osc_src {
	SYSCTL_OSC_IRC,
	SYSCTL_OSC_MAIN,
	SYSCTL_OSC_RTC,
	SYSCTL_OSC_NUM
};

enum sysctl_main_osc_range {
	SYSCTL_MAIN_OSC_RANGE_1_TO_20_MHZ,
	SYSCTL_MAIN_OSC_RANGE_15_TO_25_MHZ
};

enum sysctl_clkout_clk_src {
	SYSCTL_CLKOUT_CLK_SRC_CPU,
	SYSCTL_CLKOUT_CLK_SRC_MAIN,
	SYSCTL_CLKOUT_CLK_SRC_IRC,
	SYSCTL_CLKOUT_CLK_SRC_USB,
	SYSCTL_CLKOUT_CLK_SRC_RTC
};

enum sysctl_clkout_clk_div {
	SYSCTL_CLKOUT_CLK_DIV_1,
	SYSCTL_CLKOUT_CLK_DIV_2,
	SYSCTL_CLKOUT_CLK_DIV_3,
	SYSCTL_CLKOUT_CLK_DIV_4,
	SYSCTL_CLKOUT_CLK_DIV_5,
	SYSCTL_CLKOUT_CLK_DIV_6,
	SYSCTL_CLKOUT_CLK_DIV_7,
	SYSCTL_CLKOUT_CLK_DIV_8,
	SYSCTL_CLKOUT_CLK_DIV_9,
	SYSCTL_CLKOUT_CLK_DIV_10,
	SYSCTL_CLKOUT_CLK_DIV_11,
	SYSCTL_CLKOUT_CLK_DIV_12,
	SYSCTL_CLKOUT_CLK_DIV_13,
	SYSCTL_CLKOUT_CLK_DIV_14,
	SYSCTL_CLKOUT_CLK_DIV_15,
	SYSCTL_CLKOUT_CLK_DIV_16
};

enum sysctl_usbclk {
	SYSCTL_USBCLK_PLL0_DIV_6 = 5,
	SYSCTL_USBCLK_PLL0_DIV_8 = 7,
	SYSCTL_USBCLK_PLL0_DIV_10 = 9
};

struct sysctl_pll_cfg {
	u32 pll_mul;
	u32 pll_div;
	u32 osc_src;
	u32 cclkcfg_div;
};

void sysctl_peripheral_power_enable(enum sysctl_pconp_bit mask);
void sysctl_peripheral_power_disable(enum sysctl_pconp_bit mask);

void sysctl_clkout_cfg_set(enum sysctl_clkout_clk_src clk_src,
			   enum sysctl_clkout_clk_div clk_div);

void sysctl_main_osc_enable(enum sysctl_main_osc_range osc_range);
void sysctl_pll0_cclk_cfg(const struct sysctl_pll_cfg *cfg);

void sysctl_flash_access_time_set(
	enum sysctl_flash_access_time flash_access_time);

void sysctl_usbclk_set(enum sysctl_usbclk clk);
